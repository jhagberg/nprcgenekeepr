---
title: "Interactive Use of nprcmanager"
output:
  html_document:
    df_print: paged
vignette: |
  %\VignetteEngine{knitr::knitr} 
  %\VignetteIndexEntry{Genetic Management Tools} 
  %\usepackage[UTF-8]{inputenc}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,include=TRUE, results="markup")
```

```{r, include = FALSE}
library(nprcmanager)
library(stringi)
suppressMessages(library(ggplot2))
library(knitr)
library(rmsutilityr)

```

## Reading in Pedigrees

Pedigrees can be imported using Excel worksheets, text files, and by using
a list of animals where the remainder of the pedigree information comes
in through a LabKey API.

This tutorial will use a pedigree file that can be created using the 
__makeExamplePedigreeFile__ function as shown below. Note: the user 
will select where to store the file.
```{r make-example-pedigree, eval = FALSE, include = TRUE}
library(nprcmanager)
pedigreeFile <- makeExamplePedigreeFile()

```
This writes _ExamplePedigree.csv_ to a place you select within your file
system.

```{r get-file-name, eval = TRUE, echo = FALSE, include = FALSE}
library(nprcmanager)
pedigreeFile <- "/Users/msharp/Documents/Development/R/r_workspace/library/nprcmanager/inst/extdata/Example_Pedigree.csv"


```

You use the file name provided by the __makeExamplePedigreeFile__ function
to tell __read.table__ what file to read.

There 
```{r read-in-example-pedigree}
breederPedCsv <- read.table(pedigreeFile, sep = ",", header = TRUE,
                            stringsAsFactors = FALSE)
```
Note the number of rows read.
```{r row-count}
nrow(breederPedCsv)
```

The next step is to put the information in the file format into a 
pedigree object. During this process the function __qcStudbook__ examines the
file contents and tests for common pedigree errors.

**The various error types should be listed**

```{r form-pedigree-object}
breederPed <- qcStudbook(breederPedCsv, minParentAge = 0)

```

If __qcStudbook__ reports and error, change the call by adding the __reportErrors__
argument set to __TRUE__ and examine the returned object.

**Need a better bad pedigree file to demonstrate more errors**
**Have the bad pedigree generated by a function also**
```{r examine-errors}
badPedigreeFile <- "/Users/msharp/Documents/Development/R/r_workspace/library/nprcmanager/inst/extdata/pedigree_files_with_errors/Pedigree_File_Example_CSV.csv"
badPedCsv <- read.table(badPedigreeFile, sep = ",", header = TRUE, stringsAsFactors = FALSE)
errorLst <- qcStudbook(badPedCsv, minParentAge, reportErrors = TRUE)
summary(errorLst)
```
## Age Sex Pyramid Plot

You can examine the population structure using an age-sex pyramid
plot with a single function.

```{r plot-age-sex-pyramid, include = TRUE}
getPyramidPlot(ped = breederPed)
```

## Genetic Value Analysis

```{r genetic-value-summary}
## What is the purpose for each of the following 3 lines?
ped <- resetPopulation(breederPed, NULL)
probands <- ped$id[ped$population]
ped <- trimPedigree(probands, ped, removeUninformative = FALSE,
                    addBackParents = FALSE)

## Need a brief discussion of iterations (guIter), threshold (guThresh),
## and byID.

geneticValue <- reportGV(ped, guIter = 500,
                         guThresh = 3,
                         byID = TRUE,
                         updateProgress = NULL)
summary(geneticValue)

```

**Detailed look at the genetic value report**

```{r look-at-genetic-value-report}
rpt <- geneticValue[["report"]]
g <- rpt
g$indivMeanKin <- round(g$indivMeanKin, 5)
g$zScores <- round(g$zScores, 2)
g$gu <- round(g$gu, 5)
g <- toCharacter(g)
names(g) <- headerDisplayNames(names(g))
knitr::kable(g[1:10, ]) # needs more work for display purposes.
```
```{r kinship-and-founders}
kmat <- geneticValue[["kinship"]]
f <- geneticValue[["total"]]
mf <- geneticValue[["maleFounders"]]
ff <- geneticValue[["femaleFounders"]]
fe <- geneticValue[["fe"]]
fg <- geneticValue[["fg"]]

mk <- rpt[, "indivMeanKin"]
gu <- rpt[, "gu"]
guBox <- ggplot(data.frame(gu = gu), aes(x = "", y = gu)) +
  geom_boxplot(
    color = "darkblue",
    fill = "lightblue",
    notch = TRUE,
    outlier.color = "red",
    outlier.shape = 1
  ) +
  theme_classic() + geom_jitter(width = 0.2) + coord_flip() +
  ylab("Score")  + ggtitle("Genetic Uniqueness")
print(guBox)

gu <- rpt[, "indivMeanKin"]
gu <- rpt[, "zScores"]
```

To use the __findLoops__ function run the following code and select a pedigree as your input
file that has a loop in it. I have used the example pedigree that comes with the software
_Example_Pedigree.csv_.

```{r findLoops}
##pedigreeFile <- file.choose() ## use example file
pedigreeFile <- "/Users/msharp/Documents/Development/R/r_workspace/library/nprcmanager/inst/extdata/Example_Pedigree.csv"

examplePedigree_raw <- read.table(pedigreeFile, sep = ",", header = TRUE, 
                                   stringsAsFactors = FALSE)
errorLst <- qcStudbook(examplePedigree_raw, minParentAge = 0, reportErrors = TRUE)
print(stri_c("Non-female dams: ", get_and_or_list(errorLst$maleDams), 
             ". These happen to be classified as hermaphrodites."))
```
```{r look-at-loops}
examplePedigree <- qcStudbook(examplePedigree_raw, minParentAge = 0)
exampleTree <- createPedTree(examplePedigree)
exampleLoops <- findLoops(exampleTree)

```
You can count how many loops you have with the following codel
```{r countLoops}
length(exampleLoops[exampleLoops == TRUE])
nLoops <- countLoops(exampleLoops, exampleTree)
sum(unlist(nLoops[nLoops > 0]))

```

You can list the first 10 sets of ids, sires and dams in loops with the following line of code:

```{r listLoops}

examplePedigree[exampleLoops == TRUE, c("id", "sire", "dam")][1:10, ]


```
